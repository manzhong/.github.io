<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":false,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="KuDu 一概述 背景介绍 在KUDU之前，大数据主要以两种方式存储；   （1）静态数据：   以 HDFS 引擎作为存储引擎，适用于高吞吐量的离线大数据分析场景。  这类存储的局限性是数据无法进行随机的读写。   （2）动态数据：   以 HBase、Cassandra 作为存储引擎，适用于大数据随机读写场景。  局限性是批量读取吞吐量远不如 HDFS，不适用于批量数据分析的场景。  从上面分">
<meta property="og:type" content="article">
<meta property="og:title" content="Kudu">
<meta property="og:url" content="http://example.com/2017/07/14/kudu/index.html">
<meta property="og:site_name" content="春雨里洗过的太阳">
<meta property="og:description" content="KuDu 一概述 背景介绍 在KUDU之前，大数据主要以两种方式存储；   （1）静态数据：   以 HDFS 引擎作为存储引擎，适用于高吞吐量的离线大数据分析场景。  这类存储的局限性是数据无法进行随机的读写。   （2）动态数据：   以 HBase、Cassandra 作为存储引擎，适用于大数据随机读写场景。  局限性是批量读取吞吐量远不如 HDFS，不适用于批量数据分析的场景。  从上面分">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/kudu/t.png">
<meta property="og:image" content="http://example.com/images/kudu/t2.png">
<meta property="og:image" content="http://example.com/images/kudu/dcs.png">
<meta property="og:image" content="http://example.com/images/kudu/dcs2.png">
<meta property="og:image" content="http://example.com/images/kudu/dcs3.png">
<meta property="og:image" content="http://example.com/images/kudu/f.png">
<meta property="og:image" content="http://example.com/images/kudu/w.png">
<meta property="og:image" content="http://example.com/images/kudu/r.png">
<meta property="og:image" content="http://example.com/images/kudu/updata.png">
<meta property="article:published_time" content="2017-07-14T10:31:05.000Z">
<meta property="article:modified_time" content="2020-12-13T13:16:20.429Z">
<meta property="article:author" content="HF">
<meta property="article:tag" content="Kudu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/kudu/t.png">

<link rel="canonical" href="http://example.com/2017/07/14/kudu/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<link rel="stylesheet" type="text/css" href="/css/injector.css" />
  <title>Kudu | 春雨里洗过的太阳</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">春雨里洗过的太阳</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">世间所有的相遇，都是久别重逢</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/07/14/kudu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/hexo.jpg">
      <meta itemprop="name" content="HF">
      <meta itemprop="description" content="第二名就是头号输家">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春雨里洗过的太阳">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kudu
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-14 18:31:05" itemprop="dateCreated datePublished" datetime="2017-07-14T18:31:05+08:00">2017-07-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-13 21:16:20" itemprop="dateModified" datetime="2020-12-13T21:16:20+08:00">2020-12-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kudu/" itemprop="url" rel="index"><span itemprop="name">Kudu</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>32k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>29 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="KuDu"><a href="#KuDu" class="headerlink" title="KuDu"></a>KuDu</h1><h2 id="一概述"><a href="#一概述" class="headerlink" title="一概述"></a>一概述</h2><h3 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h3><p>在KUDU之前，大数据主要以两种方式存储；   </p>
<p>（1）静态数据：</p>
<p>   以 HDFS 引擎作为存储引擎，适用于高吞吐量的离线大数据分析场景。</p>
<p>这类存储的局限性是数据无法进行随机的读写。 </p>
<p>（2）动态数据：</p>
<p>   以 HBase、Cassandra 作为存储引擎，适用于大数据随机读写场景。</p>
<p>局限性是批量读取吞吐量远不如 HDFS，不适用于批量数据分析的场景。</p>
<p>从上面分析可知，这两种数据在存储方式上完全不同，进而导致使用场景完全不同，但在真实的场景中，边界可能没有那么清晰，面对既需要随机读写，又需要批量分析的大数据场景，该如何选择呢？</p>
<p>这个场景中，单种存储引擎无法满足业务需求，我们需要通过多种大数据工具组合来满足这一需求</p>
<p><img src="/images/kudu/t.png" alt="img"></p>
<p>如上图所示，数据实时写入 HBase，实时的数据更新也在 HBase 完成，为了应对 OLAP 需求，我们定时将 HBase 数据写成静态的文件（如：Parquet）导入到 OLAP 引擎（如：Impala、hive）。这一架构能满足既需要随机读写，又可以支持 OLAP 分析的场景，但他有如下缺点：</p>
<p>(1)<strong>架构复杂</strong>。从架构上看，数据在HBase、消息队列、HDFS 间流转，涉及环节太多，运维成本很高。并且每个环节需要保证高可用，都需要维护多个副本，存储空间也有一定的浪费。最后数据在多个系统上，对数据安全策略、监控等都提出了挑战。</p>
<p>(2)<strong>时效性低</strong>。数据从HBase导出成静态文件是周期性的，一般这个周期是一天（或一小时），在时效性上不是很高。</p>
<p>(3)<strong>难以应对后续的更新</strong>。真实场景中，总会有数据是延迟到达的。如果这些数据之前已经从HBase导出到HDFS，新到的变更数据就难以处理了，一个方案是把原有数据应用上新的变更后重写一遍，但这代价又很高。</p>
<p>为了解决上述架构的这些问题，KUDU应运而生。<strong>KUDU</strong>的定位是Fast Analytics on Fast Data，<strong>是一个既支持随机读写、又支持 OLAP 分析的大数据存储引擎</strong>。</p>
<p>KUDU 是一个折中的产品，在 HDFS 和 HBase 这两个偏科生中平衡了随机读写和批量分析的性能。从 KUDU 的诞生可以说明一个观点：底层的技术发展很多时候都是上层的业务推动的，脱离业务的技术很可能是空中楼阁。</p>
<p>kudu是什么</p>
<ul>
<li>是一个大数据存储引擎  用于大数据的存储，结合其他软件开展数据分析。</li>
<li>汲取了hdfs中高吞吐数据的能力和hbase中高随机读写数据的能力  </li>
<li>既满足有传统OLAP分析 又满足于随机读写访问数据</li>
<li>kudu来自于cloudera 后来贡献给了apache</li>
</ul>
<p>kudu应用场景</p>
<p>适用于那些既有随机访问，也有批量数据扫描的复合场景</p>
<p>高计算量的场景</p>
<p>使用了高性能的存储设备，包括使用更多的内存</p>
<p>支持数据更新，避免数据反复迁移</p>
<p>支持跨地域的实时数据备份和查询</p>
<h2 id="二架构"><a href="#二架构" class="headerlink" title="二架构"></a>二架构</h2><ul>
<li>kudu集群是主从架构<ul>
<li>主角色 master ：管理集群  管理元数据</li>
<li>从角色 tablet server：负责最终数据的存储 对外提供数据读写能力 里面存储的都是一个个tablet</li>
</ul>
</li>
<li>kudu tablet<ul>
<li>是kudu表中的数据水平分区  一个表可以划分成为多个tablet(类似于hbase  region)</li>
<li>tablet中主键是不重复连续的  所有tablet加起来就是一个table的所有数据</li>
<li>tablet在存储的时候 会进行冗余存放 设置多个副本 </li>
<li>在一个tablet所有冗余中 任意时刻 一个是leader 其他的冗余都是follower</li>
</ul>
</li>
</ul>
<p>与HDFS和HBase相似，Kudu使用单个的Master节点，用来管理集群的元数据，并且使用任意数量的Tablet Server（类似HBase中的RegionServer角色）节点用来存储实际数据。可以部署多个Master节点来提高容错性。</p>
<p><img src="/images/kudu/t2.png" alt="img"></p>
<h2 id="1．-Table"><a href="#1．-Table" class="headerlink" title="1． Table"></a>1． Table</h2><p>表（Table）是数据库中用来存储数据的对象，是有结构的数据集合。kudu中的表具有schema（纲要）和全局有序的primary key（主键）。kudu中一个table会被水平分成多个被称之为tablet的片段。</p>
<h2 id="2．-Tablet"><a href="#2．-Tablet" class="headerlink" title="2． Tablet"></a>2． Tablet</h2><p>一个 tablet 是一张 table连续的片段，tablet是kudu表的水平分区，类似于HBase的region。每个tablet存储着一定连续range的数据（key），且tablet两两间的range不会重叠。一张表的所有tablet包含了这张表的所有key空间。</p>
<p>tablet 会冗余存储。放置到多个 tablet server上，并且在任何给定的时间点，其中一个副本被认为是leader tablet,其余的被认之为follower tablet。每个tablet都可以进行数据的读请求，但只有Leader tablet负责写数据请求。</p>
<h2 id="3．-Tablet-Server"><a href="#3．-Tablet-Server" class="headerlink" title="3． Tablet Server"></a>3． Tablet Server</h2><p>tablet server集群中的小弟，负责数据存储，并提供数据读写服务</p>
<p>一个 tablet server 存储了table表的tablet，向kudu client 提供读取数据服务。对于给定的 tablet，一个tablet server 充当 leader，其他 tablet server 充当该 tablet 的 follower 副本。</p>
<p>只有 leader服务写请求，然而 leader 或 followers 为每个服务提供读请求 。一个 tablet server 可以服务多个 tablets ，并且一个 tablet 可以被多个 tablet servers 服务着。</p>
<h2 id="4．-Master-Server"><a href="#4．-Master-Server" class="headerlink" title="4． Master Server"></a>4． Master Server</h2><p>集群中的老大，负责集群管理、元数据管理等功能。</p>
<h2 id="三-kudu安装"><a href="#三-kudu安装" class="headerlink" title="三 kudu安装"></a>三 kudu安装</h2><p>1节点规划</p>
<table>
<thead>
<tr>
<th><strong>节点</strong></th>
<th><strong>kudu-master</strong></th>
<th><strong>kudu-tserver</strong></th>
</tr>
</thead>
<tbody><tr>
<td>node01</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>node02</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>node03</td>
<td>是</td>
<td>是</td>
</tr>
</tbody></table>
<p>本次配置node01 和node02 不配置 kudu-master</p>
<p>2本地yum源配置</p>
<p>配过了在 node03上</p>
<p>3 安装KUDU</p>
<table>
<thead>
<tr>
<th><strong>服务器</strong></th>
<th><strong>安装命令</strong></th>
</tr>
</thead>
<tbody><tr>
<td>node01</td>
<td>yum   install -y kudu kudu-tserver kudu-client0 kudu-client-devel</td>
</tr>
<tr>
<td>node02</td>
<td>yum   install -y kudu kudu-tserver kudu-client0 kudu-client-devel</td>
</tr>
<tr>
<td>node03</td>
<td>yum   install -y kudu kudu-master kudu-tserver kudu-client0 kudu-client-devel</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install kudu # Kudu的基本包</span><br><span class="line">yum install kudu-master # KuduMaster </span><br><span class="line">yum install kudu-tserver # KuduTserver </span><br><span class="line">yum install kudu-client0 #Kudu C ++客户端共享库</span><br><span class="line">yum install kudu-client-devel # Kudu C ++客户端共享库 SDK</span><br></pre></td></tr></table></figure>

<p>4 kudu节点配置</p>
<p>安装完成之后。 需要在所有节点的/etc/kudu/conf目录下有两个文件：master.gflagfile和tserver.gflagfile。</p>
<h3 id="1-1．-修改master-gflagfile"><a href="#1-1．-修改master-gflagfile" class="headerlink" title="1.1． 修改master.gflagfile"></a>1.1． 修改master.gflagfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;etc&#x2F;kudu&#x2F;conf&#x2F;master.gflagfile</span><br><span class="line"># Do not modify these two lines. If you wish to change these variables,</span><br><span class="line"># modify them in &#x2F;etc&#x2F;default&#x2F;kudu-master.</span><br><span class="line">--fromenv&#x3D;rpc_bind_addresses</span><br><span class="line">--fromenv&#x3D;log_dir</span><br><span class="line">--fs_wal_dir&#x3D;&#x2F;export&#x2F;servers&#x2F;kudu&#x2F;master</span><br><span class="line">--fs_data_dirs&#x3D;&#x2F;export&#x2F;servers&#x2F;kudu&#x2F;master</span><br><span class="line">--master_addresses&#x3D;node03:7051     若为集node01:7051,node02:7051,node03:7051 若为单节点 则这句注释掉</span><br><span class="line">若为单节点 且没注释掉 则启动报错</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-2-修改tserver-gflagfile"><a href="#1-2-修改tserver-gflagfile" class="headerlink" title="1.2 修改tserver.gflagfile"></a>1.2 修改tserver.gflagfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Do not modify these two lines. If you wish to change these variables,</span><br><span class="line"># modify them in &#x2F;etc&#x2F;default&#x2F;kudu-tserver.</span><br><span class="line">--fromenv&#x3D;rpc_bind_addresses</span><br><span class="line">--fromenv&#x3D;log_dir</span><br><span class="line">--fs_wal_dir&#x3D;&#x2F;export&#x2F;servers&#x2F;kudu&#x2F;tserver</span><br><span class="line">--fs_data_dirs&#x3D;&#x2F;export&#x2F;servers&#x2F;kudu&#x2F;tserver</span><br><span class="line">--tserver_master_addrs&#x3D;node03:7051  若为集node01:7051,node02:7051,node03:7051  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-3修改-etc-default-kudu-master"><a href="#1-3修改-etc-default-kudu-master" class="headerlink" title="1.3修改 /etc/default/kudu-master"></a>1.3修改 /etc/default/kudu-master</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export FLAGS_log_dir&#x3D;&#x2F;var&#x2F;log&#x2F;kudu</span><br><span class="line">#每台机器的master地址要与主机名一致,这里是在node03上</span><br><span class="line">export FLAGS_rpc_bind_addresses&#x3D;node03:7051</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-4修改-etc-default-kudu-tserver"><a href="#1-4修改-etc-default-kudu-tserver" class="headerlink" title="1.4修改 /etc/default/kudu-tserver"></a>1.4修改 /etc/default/kudu-tserver</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export FLAGS_log_dir&#x3D;&#x2F;var&#x2F;log&#x2F;kudu</span><br><span class="line">#每台机器的tserver地址要与主机名一致，这里是在node03上</span><br><span class="line">export FLAGS_rpc_bind_addresses&#x3D;node03:7050</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>kudu默认用户就是KUDU，所以需要将/export/servers/kudu权限修改成kudu：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;export&#x2F;servers&#x2F;kudu</span><br><span class="line">chown -R kudu:kudu &#x2F;export&#x2F;servers&#x2F;kudu</span><br></pre></td></tr></table></figure>

<p>(如果使用的是普通的用户，那么最好配置sudo权限)/etc/sudoers文件中添加：</p>
<p><strong>kudu集群的启动与关闭</strong></p>
<p>1 ntp服务的安装</p>
<p>启动的时候要注意时间同步</p>
<p>安装ntp服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ntp</span><br></pre></td></tr></table></figure>

<p>设置开机启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service ntpd start </span><br><span class="line">chkconfig ntpd on</span><br></pre></td></tr></table></figure>

<p>可以在每台服务器执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;ntpd restart</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">启动</span><br><span class="line">service kudu-master start</span><br><span class="line">service kudu-tserver start</span><br><span class="line">关闭</span><br><span class="line">service kudu-master stop</span><br><span class="line">service kudu-tserver stop</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kudu的web管理界面。http:&#x2F;&#x2F;master主机名:8051</span><br><span class="line"></span><br><span class="line">可以查看每个机器上master相关信息。http:&#x2F;&#x2F;node03:8051&#x2F;masters    一定为8051 不为7051</span><br><span class="line"></span><br><span class="line">tserver 的web地址  http:&#x2F;&#x2F;node03:8051&#x2F;tablet-servers</span><br></pre></td></tr></table></figure>

<p>安装属于事项</p>
<h3 id="1-1给普通用户授予sudo出错"><a href="#1-1给普通用户授予sudo出错" class="headerlink" title="1.1给普通用户授予sudo出错"></a>1.1给普通用户授予sudo出错</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo: &#x2F;etc&#x2F;sudoers is world writable</span><br><span class="line">解决方式：&#96;&#96;pkexec chmod 555 &#x2F;etc&#x2F;sudoers</span><br></pre></td></tr></table></figure>

<h3 id="1-2-启动kudu的时候报错"><a href="#1-2-启动kudu的时候报错" class="headerlink" title="1.2 启动kudu的时候报错"></a>1.2 启动kudu的时候报错</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Failed to start Kudu Master Server. Return value: 1 [FAILED]</span><br><span class="line">去日志文件中查看：</span><br><span class="line">Service unavailable: Cannot initialize clock: Errorreading clock. Clock considered</span><br><span class="line">unsynchronized</span><br><span class="line">解决：</span><br><span class="line">第一步：首先检查是否有安装ntp：如果没有安装则使用以下命令安装：</span><br><span class="line">yum -y install ntp</span><br><span class="line">第二步：设置随机启动：</span><br><span class="line">service ntpd start</span><br><span class="line">chkconfig ntpd on</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-3-启动过程中报错"><a href="#1-3-启动过程中报错" class="headerlink" title="1.3 启动过程中报错"></a>1.3 启动过程中报错</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Invalid argument: Unable to initialize catalog manager: Failed to initialize sys</span><br><span class="line">tables</span><br><span class="line">async: on-disk master list</span><br><span class="line">解决：</span><br><span class="line">（1）：停掉master和tserver</span><br><span class="line">（2）：删除掉之前所有的&#x2F;export&#x2F;servers&#x2F;kudu&#x2F;master&#x2F;*和&#x2F;export&#x2F;servers&#x2F;kudu&#x2F;tserver&#x2F;*</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="1-4-启动过程中报错"><a href="#1-4-启动过程中报错" class="headerlink" title="1.4 启动过程中报错"></a>1.4 启动过程中报错</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">error: Could not create new FS layout: unable to create file system roots: unable to</span><br><span class="line">write instance metadata: Call to mkstemp() failed on name template</span><br><span class="line">&#x2F;export&#x2F;servers&#x2F;kudu&#x2F;master&#x2F;instance.kudutmp.XXXXXX: Permission denied (error 13)</span><br><span class="line">这是因为kudu默认使用kudu权限进行执行，可能遇到文件夹的权限不一致情况，更改文件夹权限即可</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="四-Java操作kudu"><a href="#四-Java操作kudu" class="headerlink" title="四 Java操作kudu"></a>四 Java操作kudu</h2><p>###1 创建maven工程 导入依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;  </span><br><span class="line">   &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.apache.kudu&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;kudu-client&lt;&#x2F;artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.6.0&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;junit&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;junit&lt;&#x2F;artifactId&gt;</span><br><span class="line">      &lt;version&gt;4.12&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-初始化方法"><a href="#2-初始化方法" class="headerlink" title="2 初始化方法"></a>2 初始化方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class TestKudu &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;声明全局变量 KuduClient后期通过它来操作kudu表</span><br><span class="line">    private KuduClient kuduClient;</span><br><span class="line">    &#x2F;&#x2F;指定kuduMaster地址</span><br><span class="line">    private String kuduMaster;</span><br><span class="line">    &#x2F;&#x2F;指定表名</span><br><span class="line">    private String tableName;</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    public void init()&#123;</span><br><span class="line">        &#x2F;&#x2F;初始化操作</span><br><span class="line">        kuduMaster&#x3D;&quot;node03:7051&quot;;</span><br><span class="line">        &#x2F;&#x2F;指定表名</span><br><span class="line">        tableName&#x3D;&quot;student&quot;;</span><br><span class="line">        KuduClient.KuduClientBuilder kuduClientBuilder &#x3D; new KuduClient.KuduClientBuilder(kuduMaster);</span><br><span class="line">		&#x2F;&#x2F;设置客户端与kudu集群socket超时时间</span><br><span class="line">        kuduClientBuilder.defaultSocketReadTimeoutMs(10000);</span><br><span class="line">        kuduClient&#x3D;kuduClientBuilder.build();</span><br><span class="line">    &#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-创建表"><a href="#3-创建表" class="headerlink" title="3 创建表"></a>3 创建表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 创建表</span><br><span class="line"> *&#x2F;</span><br><span class="line">@Test</span><br><span class="line">public void createTable() throws KuduException &#123;</span><br><span class="line">    &#x2F;&#x2F;判断表是否存在，不存在就构建</span><br><span class="line">    if(!kuduClient.tableExists(tableName))&#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;构建创建表的schema信息-----就是表的字段和类型</span><br><span class="line">        ArrayList&lt;ColumnSchema&gt; columnSchemas &#x3D; new ArrayList&lt;ColumnSchema&gt;();</span><br><span class="line">        columnSchemas.add(new ColumnSchema.ColumnSchemaBuilder(&quot;id&quot;, Type.INT32).key(true).build());</span><br><span class="line">        columnSchemas.add(new ColumnSchema.ColumnSchemaBuilder(&quot;name&quot;, Type.STRING).build());</span><br><span class="line">        columnSchemas.add(new ColumnSchema.ColumnSchemaBuilder(&quot;age&quot;, Type.INT32).build());</span><br><span class="line">        columnSchemas.add(new ColumnSchema.ColumnSchemaBuilder(&quot;sex&quot;, Type.INT32).build());</span><br><span class="line">        Schema schema &#x3D; new Schema(columnSchemas);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;指定创建表的相关属性</span><br><span class="line">        CreateTableOptions options &#x3D; new CreateTableOptions();</span><br><span class="line">        ArrayList&lt;String&gt; partitionList &#x3D; new ArrayList&lt;String&gt;();</span><br><span class="line">        &#x2F;&#x2F;指定kudu表的分区字段是什么</span><br><span class="line">        partitionList.add(&quot;id&quot;);    &#x2F;&#x2F;  按照 id.hashcode % 分区数 &#x3D; 分区号</span><br><span class="line">        options.addHashPartitions(partitionList,6);</span><br><span class="line"></span><br><span class="line">        kuduClient.createTable(tableName,schema,options);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-插入数据"><a href="#4-插入数据" class="headerlink" title="4 插入数据"></a>4 插入数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  &#x2F;**</span><br><span class="line">   * 向表加载数据</span><br><span class="line">   *&#x2F;</span><br><span class="line">  @Test</span><br><span class="line">  public void insertTable() throws KuduException &#123;</span><br><span class="line">      &#x2F;&#x2F;向表加载数据需要一个kuduSession对象</span><br><span class="line">      KuduSession kuduSession &#x3D; kuduClient.newSession();</span><br><span class="line">      &#x2F;&#x2F;设置提交数据为自动flush</span><br><span class="line">      kuduSession.setFlushMode(SessionConfiguration.FlushMode.AUTO_FLUSH_SYNC);</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F;需要使用kuduTable来构建Operation的子类实例对象  就是打开本次操作的表名</span><br><span class="line">      KuduTable kuduTable &#x3D; kuduClient.openTable(tableName);</span><br><span class="line">&#x2F;&#x2F;此处需要kudutable 来构建operation的子类实例对象  此处 为insert</span><br><span class="line">      for(int i&#x3D;1;i&lt;&#x3D;10;i++)&#123;</span><br><span class="line">          Insert insert &#x3D; kuduTable.newInsert();</span><br><span class="line">          PartialRow row &#x3D; insert.getRow();</span><br><span class="line">          row.addInt(&quot;id&quot;,i);</span><br><span class="line">          row.addString(&quot;name&quot;,&quot;zhangsan-&quot;+i);</span><br><span class="line">          row.addInt(&quot;age&quot;,20+i);</span><br><span class="line">          row.addInt(&quot;sex&quot;,i%2);</span><br><span class="line"></span><br><span class="line">          kuduSession.apply(insert);&#x2F;&#x2F;最后实现执行数据的加载操作</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-查询数据"><a href="#5-查询数据" class="headerlink" title="5 查询数据"></a>5 查询数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 查询表的数据结果</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void queryData() throws KuduException &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;构建一个查询的扫描器 在扫描器中指定 表名</span><br><span class="line">        KuduScanner.KuduScannerBuilder kuduScannerBuilder &#x3D; kuduClient.newScannerBuilder(kuduClient.openTable(tableName));</span><br><span class="line">        &#x2F;&#x2F;创建集合 用于存储扫描的字段信息</span><br><span class="line">        ArrayList&lt;String&gt; columnsList &#x3D; new ArrayList&lt;String&gt;();</span><br><span class="line">        columnsList.add(&quot;id&quot;);</span><br><span class="line">        columnsList.add(&quot;name&quot;);</span><br><span class="line">        columnsList.add(&quot;age&quot;);</span><br><span class="line">        columnsList.add(&quot;sex&quot;);</span><br><span class="line">        kuduScannerBuilder.setProjectedColumnNames(columnsList);</span><br><span class="line">        &#x2F;&#x2F; 调用build方法执行扫描,返回结果集</span><br><span class="line">        KuduScanner kuduScanner &#x3D; kuduScannerBuilder.build();</span><br><span class="line">        &#x2F;&#x2F;遍历</span><br><span class="line">        while (kuduScanner.hasMoreRows())&#123;</span><br><span class="line">            RowResultIterator rowResults &#x3D; kuduScanner.nextRows();</span><br><span class="line"></span><br><span class="line">             while (rowResults.hasNext())&#123;</span><br><span class="line">                 RowResult row &#x3D; rowResults.next(); &#x2F;&#x2F;拿到的是一行数据</span><br><span class="line">                 int id &#x3D; row.getInt(&quot;id&quot;);</span><br><span class="line">                 String name &#x3D; row.getString(&quot;name&quot;);</span><br><span class="line">                 int age &#x3D; row.getInt(&quot;age&quot;);</span><br><span class="line">                 int sex &#x3D; row.getInt(&quot;sex&quot;);</span><br><span class="line"></span><br><span class="line">                 System.out.println(&quot;id&#x3D;&quot;+id+&quot;  name&#x3D;&quot;+name+&quot;  age&#x3D;&quot;+age+&quot;  sex&#x3D;&quot;+sex);</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6-修改数据"><a href="#6-修改数据" class="headerlink" title="6 修改数据"></a>6 修改数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 修改表的数据</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void updateData() throws KuduException &#123;</span><br><span class="line">        &#x2F;&#x2F;修改表的数据需要一个kuduSession对象</span><br><span class="line">        KuduSession kuduSession &#x3D; kuduClient.newSession();</span><br><span class="line">        &#x2F;&#x2F;设置提交数据为自动flush</span><br><span class="line">        kuduSession.setFlushMode(SessionConfiguration.FlushMode.AUTO_FLUSH_SYNC);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;需要使用kuduTable来构建Operation的子类实例对象</span><br><span class="line">        KuduTable kuduTable &#x3D; kuduClient.openTable(tableName);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;Update update &#x3D; kuduTable.newUpdate(); &#x2F;&#x2F;如果id不存在 ,就什么也不操作</span><br><span class="line">        Upsert upsert &#x3D; kuduTable.newUpsert(); &#x2F;&#x2F;如果id存在就表示修改，不存在就新增</span><br><span class="line">        PartialRow row &#x3D; upsert.getRow();</span><br><span class="line">        row.addInt(&quot;id&quot;,100);</span><br><span class="line">        row.addString(&quot;name&quot;,&quot;zhangsan-100&quot;);</span><br><span class="line">        row.addInt(&quot;age&quot;,100);</span><br><span class="line">        row.addInt(&quot;sex&quot;,0);</span><br><span class="line"></span><br><span class="line">        kuduSession.apply(upsert);&#x2F;&#x2F;最后实现执行数据的修改操作</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7删除数据"><a href="#7删除数据" class="headerlink" title="7删除数据"></a>7删除数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 删除数据</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void deleteData() throws KuduException &#123;</span><br><span class="line">        &#x2F;&#x2F;删除表的数据需要一个kuduSession对象</span><br><span class="line">        KuduSession kuduSession &#x3D; kuduClient.newSession();</span><br><span class="line">        kuduSession.setFlushMode(SessionConfiguration.FlushMode.AUTO_FLUSH_SYNC);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;需要使用kuduTable来构建Operation的子类实例对象</span><br><span class="line">        KuduTable kuduTable &#x3D; kuduClient.openTable(tableName);</span><br><span class="line"></span><br><span class="line">        Delete delete &#x3D; kuduTable.newDelete();</span><br><span class="line">        PartialRow row &#x3D; delete.getRow();</span><br><span class="line">        row.addInt(&quot;id&quot;,100);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        kuduSession.apply(delete);&#x2F;&#x2F;最后实现执行数据的删除操作</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="8-删除表"><a href="#8-删除表" class="headerlink" title="8 删除表"></a>8 删除表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void dropTable() throws KuduException &#123;</span><br><span class="line"></span><br><span class="line">    if(kuduClient.tableExists(tableName))&#123;</span><br><span class="line">        kuduClient.deleteTable(tableName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-kudu的分区方式"><a href="#9-kudu的分区方式" class="headerlink" title="9 kudu的分区方式"></a>9 kudu的分区方式</h3><p>为了提供可扩展性，Kudu 表被划分为称为 tablet 的单元，并分布在许多 tablet servers 上。行总是属于单个tablet 。将行分配给 tablet 的方法由在表创建期间设置的表的分区决定。 kudu提供了3种分区方式。</p>
<h4 id="1-范围分区Range-Partitioning"><a href="#1-范围分区Range-Partitioning" class="headerlink" title="1 范围分区Range Partitioning"></a>1 范围分区Range Partitioning</h4><p>范围分区可以根据存入数据的数据量，均衡的存储到各个机器上，防止机器出现负载不均衡现象.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">  * 测试分区：</span><br><span class="line">  * RangePartition</span><br><span class="line">  *&#x2F;</span><br><span class="line"> @Test</span><br><span class="line"> public void testRangePartition() throws KuduException &#123;</span><br><span class="line">     &#x2F;&#x2F;设置表的schema</span><br><span class="line">     LinkedList&lt;ColumnSchema&gt; columnSchemas &#x3D; new LinkedList&lt;ColumnSchema&gt;();</span><br><span class="line">     columnSchemas.add(new Column(&quot;id&quot;, Type.INT32,true));</span><br><span class="line">     columnSchemas.add(new Column(&quot;WorkId&quot;, Type.INT32,false));</span><br><span class="line">     columnSchemas.add(new Column(&quot;Name&quot;, Type.STRING,false));</span><br><span class="line">     columnSchemas.add(new Column(&quot;Gender&quot;, Type.STRING,false));</span><br><span class="line">     columnSchemas.add(new Column(&quot;Photo&quot;, Type.STRING,false));</span><br><span class="line"></span><br><span class="line">     &#x2F;&#x2F;创建schema</span><br><span class="line">     Schema schema &#x3D; new Schema(columnSchemas);</span><br><span class="line"></span><br><span class="line">     &#x2F;&#x2F;创建表时提供的所有选项</span><br><span class="line">     CreateTableOptions tableOptions &#x3D; new CreateTableOptions();</span><br><span class="line">     &#x2F;&#x2F;设置副本数</span><br><span class="line">     &#x2F;&#x2F;tableOptions.setNumReplicas(1);</span><br><span class="line">     &#x2F;&#x2F;设置范围分区的规则</span><br><span class="line">     LinkedList&lt;String&gt; parcols &#x3D; new LinkedList&lt;String&gt;();</span><br><span class="line">     parcols.add(&quot;id&quot;);</span><br><span class="line">     &#x2F;&#x2F;设置按照那个字段进行range分区</span><br><span class="line">     tableOptions.setRangePartitionColumns(parcols);</span><br><span class="line"></span><br><span class="line">     &#x2F;**</span><br><span class="line">      * range</span><br><span class="line">      *  0 &lt; value &lt; 10</span><br><span class="line">      * 10 &lt;&#x3D; value &lt; 20</span><br><span class="line">      * 20 &lt;&#x3D; value &lt; 30</span><br><span class="line">      * ........</span><br><span class="line">      * 80 &lt;&#x3D; value &lt; 90</span><br><span class="line">      * *&#x2F;</span><br><span class="line">     int count&#x3D;0;</span><br><span class="line">     for(int i &#x3D;0;i&lt;10;i++)&#123;</span><br><span class="line">         &#x2F;&#x2F;范围开始</span><br><span class="line">         PartialRow lower &#x3D; schema.newPartialRow();</span><br><span class="line">         lower.addInt(&quot;id&quot;,count);</span><br><span class="line"></span><br><span class="line">         &#x2F;&#x2F;范围结束</span><br><span class="line">         PartialRow upper &#x3D; schema.newPartialRow();</span><br><span class="line">         count +&#x3D;10;</span><br><span class="line">         upper.addInt(&quot;id&quot;,count);</span><br><span class="line"></span><br><span class="line">         &#x2F;&#x2F;设置每一个分区的范围</span><br><span class="line">         tableOptions.addRangePartition(lower,upper);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     try &#123;</span><br><span class="line">         kuduClient.createTable(&quot;t-range-partition&quot;,schema,tableOptions);</span><br><span class="line">     &#125; catch (KuduException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">      kuduClient.close();</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-哈希分区Hash-Partitioning-为kudu的默认分区"><a href="#2-哈希分区Hash-Partitioning-为kudu的默认分区" class="headerlink" title="2 哈希分区Hash Partitioning 为kudu的默认分区"></a>2 哈希分区Hash Partitioning 为kudu的默认分区</h4><p>哈希分区通过哈希值将行分配到许多 buckets (存储桶 )之一； 哈希分区是一种有效的策略，当不需要对表进行有序访问时。哈希分区对于在 tablet 之间随机散布这些功能是有效的，这有助于减轻热点和 tablet 大小不均匀。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 测试分区：</span><br><span class="line">     * hash分区</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void testHashPartition() throws KuduException &#123;</span><br><span class="line">        &#x2F;&#x2F;设置表的schema</span><br><span class="line">        LinkedList&lt;ColumnSchema&gt; columnSchemas &#x3D; new LinkedList&lt;ColumnSchema&gt;();</span><br><span class="line">        columnSchemas.add(new Column(&quot;id&quot;, Type.INT32,true));</span><br><span class="line">        columnSchemas.add(new Column(&quot;WorkId&quot;, Type.INT32,false));</span><br><span class="line">        columnSchemas.add(new Column(&quot;Name&quot;, Type.STRING,false));</span><br><span class="line">        columnSchemas.add(new Column(&quot;Gender&quot;, Type.STRING,false));</span><br><span class="line">        columnSchemas.add(new Column(&quot;Photo&quot;, Type.STRING,false));</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建schema</span><br><span class="line">        Schema schema &#x3D; new Schema(columnSchemas);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建表时提供的所有选项</span><br><span class="line">        CreateTableOptions tableOptions &#x3D; new CreateTableOptions();</span><br><span class="line">        &#x2F;&#x2F;设置副本数</span><br><span class="line">        tableOptions.setNumReplicas(1);</span><br><span class="line">        &#x2F;&#x2F;设置范围分区的规则</span><br><span class="line">        LinkedList&lt;String&gt; parcols &#x3D; new LinkedList&lt;String&gt;();</span><br><span class="line">        parcols.add(&quot;id&quot;);</span><br><span class="line">        &#x2F;&#x2F;设置按照那个字段进行range分区</span><br><span class="line">        tableOptions.addHashPartitions(parcols,6);</span><br><span class="line">        try &#123;</span><br><span class="line">            kuduClient.createTable(&quot;t-hash-partition&quot;,schema,tableOptions);</span><br><span class="line">        &#125; catch (KuduException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        kuduClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-多级分区Multilevel-Partitioning"><a href="#3-多级分区Multilevel-Partitioning" class="headerlink" title="3 多级分区Multilevel Partitioning"></a>3 多级分区Multilevel Partitioning</h4><p>Kudu 允许一个表在单个表上组合多级分区。 当正确使用时，多级分区可以保留各个分区类型的优点，同时减少每个分区的缺点</p>
<p>如 范围分区  为5个  hash分区为3个   则多级分区为15个  (即在范围分区里面有进行了hash分区)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 测试分区：</span><br><span class="line">     * 多级分区</span><br><span class="line">     * Multilevel Partition</span><br><span class="line">     * 混合使用hash分区和range分区</span><br><span class="line">     *</span><br><span class="line">     * 哈希分区有利于提高写入数据的吞吐量，而范围分区可以避免tablet无限增长问题，</span><br><span class="line">     * hash分区和range分区结合，可以极大的提升kudu的性能</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Test</span><br><span class="line">    public void testMultilevelPartition() throws KuduException &#123;</span><br><span class="line">        &#x2F;&#x2F;设置表的schema</span><br><span class="line">        LinkedList&lt;ColumnSchema&gt; columnSchemas &#x3D; new LinkedList&lt;ColumnSchema&gt;();</span><br><span class="line">        columnSchemas.add(new Column(&quot;id&quot;, Type.INT32,true));</span><br><span class="line">        columnSchemas.add(new Column(&quot;WorkId&quot;, Type.INT32,false));</span><br><span class="line">        columnSchemas.add(new Column(&quot;Name&quot;, Type.STRING,false));</span><br><span class="line">        columnSchemas.add(new Column(&quot;Gender&quot;, Type.STRING,false));</span><br><span class="line">        columnSchemas.add(new Column(&quot;Photo&quot;, Type.STRING,false));</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建schema</span><br><span class="line">        Schema schema &#x3D; new Schema(columnSchemas);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;创建表时提供的所有选项</span><br><span class="line">        CreateTableOptions tableOptions &#x3D; new CreateTableOptions();</span><br><span class="line">        &#x2F;&#x2F;设置副本数</span><br><span class="line">        &#x2F;&#x2F;tableOptions.setNumReplicas(1);</span><br><span class="line">        &#x2F;&#x2F;设置范围分区的规则</span><br><span class="line">        LinkedList&lt;String&gt; parcols &#x3D; new LinkedList&lt;String&gt;();</span><br><span class="line">        parcols.add(&quot;id&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;hash分区</span><br><span class="line">        tableOptions.addHashPartitions(parcols,5);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;range分区</span><br><span class="line">        int count&#x3D;0;</span><br><span class="line">        for(int i&#x3D;0;i&lt;10;i++)&#123;</span><br><span class="line">        &#x2F;&#x2F;指定上界</span><br><span class="line">            PartialRow lower &#x3D; schema.newPartialRow();</span><br><span class="line">            lower.addInt(&quot;id&quot;,count);</span><br><span class="line">            count+&#x3D;10;</span><br><span class="line">			&#x2F;&#x2F;指定下界</span><br><span class="line">            PartialRow upper &#x3D; schema.newPartialRow();</span><br><span class="line">            upper.addInt(&quot;id&quot;,count);</span><br><span class="line">            tableOptions.addRangePartition(lower,upper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            kuduClient.createTable(&quot;t-multilevel-partition&quot;,schema,tableOptions);</span><br><span class="line">        &#125; catch (KuduException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        kuduClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="五-kudu集成impala"><a href="#五-kudu集成impala" class="headerlink" title="五 kudu集成impala"></a>五 kudu集成impala</h2><h3 id="1-impala的配置修改"><a href="#1-impala的配置修改" class="headerlink" title="1 impala的配置修改"></a>1 impala的配置修改</h3><p>可选项 若配置以后写的时候指定 master地址即可</p>
<p>在每一个服务器的impala的配置文件中添加如下配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;default&#x2F;impala</span><br></pre></td></tr></table></figure>

<p>在IMPALA_SERVER_ARGS下添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-kudu_master_hosts&#x3D;node-1:7051,node-2:7051,node-3:7051</span><br></pre></td></tr></table></figure>

<h3 id="2-创建kudu表"><a href="#2-创建kudu表" class="headerlink" title="2 创建kudu表"></a>2 创建kudu表</h3><p>需要先启动hdfs、hive、kudu、impala。使用impala的shell控制台。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impala-shell</span><br></pre></td></tr></table></figure>

<p>内部表:impala中删除,kudu里也会删除  </p>
<p>外部表: impala中删除,kudu中不会删除.</p>
<p>2.1 内部表</p>
<p>内部表由Impala管理，当您从Impala中删除时，数据和表确实被删除。当您使用Impala创建新表时，它通常是内部表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE my_first_table</span><br><span class="line">(</span><br><span class="line">id BIGINT,</span><br><span class="line">name STRING,</span><br><span class="line">PRIMARY KEY(id)</span><br><span class="line">)</span><br><span class="line">PARTITION BY HASH PARTITIONS 16 </span><br><span class="line">STORED AS KUDU</span><br><span class="line">TBLPROPERTIES (</span><br><span class="line">&#39;kudu.master_addresses&#39; &#x3D; &#39;node1:7051,node2:7051,node3:7051&#39;,  &#x2F;&#x2F;这种就是没有配置以上的 指定地址</span><br><span class="line">&#39;kudu.table_name&#39; &#x3D; &#39;my_first_table&#39;</span><br><span class="line">);</span><br><span class="line">    </span><br><span class="line">在 CREATE TABLE 语句中，必须首先列出构成主键的列。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.2 外部表</p>
<p>外部表（创建者CREATE EXTERNAL TABLE）不受Impala管理，并且删除此表不会将表从其源位置（此处为Kudu）丢弃。相反，它只会去除Impala和Kudu之间的映射。这是Kudu提供的用于将现有表映射到Impala的语法。</p>
<p>首先使用java创建kudu表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">public class CreateTable &#123;</span><br><span class="line">        private static ColumnSchema newColumn(String name, Type type, boolean iskey) &#123;</span><br><span class="line">                ColumnSchema.ColumnSchemaBuilder column &#x3D; new</span><br><span class="line">                    ColumnSchema.ColumnSchemaBuilder(name, type);</span><br><span class="line">                column.key(iskey);</span><br><span class="line">                return column.build();</span><br><span class="line">        &#125;</span><br><span class="line">    public static void main(String[] args) throws KuduException &#123;</span><br><span class="line">        &#x2F;&#x2F; master地址</span><br><span class="line">        final String masteraddr &#x3D; &quot;node1,node2,node3&quot;;</span><br><span class="line">        &#x2F;&#x2F; 创建kudu的数据库链接</span><br><span class="line">        KuduClient client &#x3D; new</span><br><span class="line">     KuduClient.KuduClientBuilder(masteraddr).defaultSocketReadTimeoutMs(6000).build();</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 设置表的schema</span><br><span class="line">        List&lt;ColumnSchema&gt; columns &#x3D; new LinkedList&lt;ColumnSchema&gt;();</span><br><span class="line">        columns.add(newColumn(&quot;CompanyId&quot;, Type.INT32, true));</span><br><span class="line">        columns.add(newColumn(&quot;WorkId&quot;, Type.INT32, false));</span><br><span class="line">        columns.add(newColumn(&quot;Name&quot;, Type.STRING, false));</span><br><span class="line">        columns.add(newColumn(&quot;Gender&quot;, Type.STRING, false));</span><br><span class="line">        columns.add(newColumn(&quot;Photo&quot;, Type.STRING, false));</span><br><span class="line">        Schema schema &#x3D; new Schema(columns);</span><br><span class="line">    &#x2F;&#x2F;创建表时提供的所有选项</span><br><span class="line">    CreateTableOptions options &#x3D; new CreateTableOptions();</span><br><span class="line">        </span><br><span class="line">    &#x2F;&#x2F; 设置表的replica备份和分区规则</span><br><span class="line">    List&lt;String&gt; parcols &#x3D; new LinkedList&lt;String&gt;();</span><br><span class="line">        </span><br><span class="line">    parcols.add(&quot;CompanyId&quot;);</span><br><span class="line">    &#x2F;&#x2F;设置表的备份数</span><br><span class="line">        options.setNumReplicas(1);</span><br><span class="line">    &#x2F;&#x2F;设置range分区</span><br><span class="line">    options.setRangePartitionColumns(parcols);</span><br><span class="line">        </span><br><span class="line">    &#x2F;&#x2F;设置hash分区和数量</span><br><span class="line">    options.addHashPartitions(parcols, 3);</span><br><span class="line">    try &#123;</span><br><span class="line">    client.createTable(&quot;person&quot;, schema, options);</span><br><span class="line">    &#125; catch (KuduException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用impala创建外部表 ， 将kudu的表映射到impala上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在impala-shell中执行</span><br><span class="line"></span><br><span class="line">CREATE EXTERNAL TABLE &#96;person&#96; STORED AS KUDU</span><br><span class="line">TBLPROPERTIES(</span><br><span class="line">    &#39;kudu.table_name&#39; &#x3D; &#39;person&#39;,</span><br><span class="line">    &#39;kudu.master_addresses&#39; &#x3D; &#39;node1:7051,node2:7051,node3:7051&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-使用impala对kudu进行DML"><a href="#3-使用impala对kudu进行DML" class="headerlink" title="3 使用impala对kudu进行DML"></a>3 使用impala对kudu进行DML</h3><p>1 插入数据</p>
<p>impala 允许使用标准 SQL 语句将数据插入 Kudu 。</p>
<p>首先建表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">在impala-shell中</span><br><span class="line">CREATE TABLE my_first_table1</span><br><span class="line">(</span><br><span class="line">id BIGINT,</span><br><span class="line">name STRING,</span><br><span class="line">PRIMARY KEY(id)</span><br><span class="line">)</span><br><span class="line">PARTITION BY HASH PARTITIONS 16</span><br><span class="line">STORED AS KUDU </span><br><span class="line">TBLPROPERTIES(</span><br><span class="line">    &#39;kudu.table_name&#39; &#x3D; &#39;person1&#39;,</span><br><span class="line">    &#39;kudu.master_addresses&#39; &#x3D; &#39;node1:7051,node2:7051,node3:7051&#39;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此示例插入单个行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO my_first_table VALUES (50, &quot;zhangsan&quot;);</span><br></pre></td></tr></table></figure>

<p>此示例插入3行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO my_first_table VALUES (1, &quot;john&quot;), (2, &quot;jane&quot;), (3, &quot;jim&quot;);</span><br></pre></td></tr></table></figure>

<p>批量导入数据：</p>
<p>从 Impala 和 Kudu 的角度来看，通常表现最好的方法通常是使用 Impala 中的 SELECT FROM 语句导入数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO my_first_table SELECT * FROM temp1;</span><br></pre></td></tr></table></figure>

<p>2 更新数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE my_first_table SET name&#x3D;&quot;xiaowang&quot; where id &#x3D;1 ;</span><br></pre></td></tr></table></figure>

<p>3 删除数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete from my_first_table where id &#x3D;2;</span><br></pre></td></tr></table></figure>

<p>4 更改表属性</p>
<p>4.1重命名impala表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE PERSON RENAME TO person_temp;</span><br></pre></td></tr></table></figure>

<p> 4.2重新命名内部表的基础kudu表</p>
<pre><code>              4.1.1创建内部表</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE kudu_student</span><br><span class="line">(</span><br><span class="line">CompanyId INT,</span><br><span class="line">WorkId INT,</span><br><span class="line">Name STRING,</span><br><span class="line">Gender STRING,</span><br><span class="line">Photo STRING,</span><br><span class="line">PRIMARY KEY(CompanyId)</span><br><span class="line">)</span><br><span class="line">PARTITION BY HASH PARTITIONS 16</span><br><span class="line">STORED AS KUDU</span><br><span class="line">TBLPROPERTIES (</span><br><span class="line">&#39;kudu.master_addresses&#39; &#x3D; &#39;node1:7051,node2:7051,node3:7051&#39;,</span><br><span class="line">&#39;kudu.table_name&#39; &#x3D; &#39;student&#39;</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​                4.1.2如果表是内部表，则可以通过更改 kudu.table_name 属性重命名底层的 Kudu 表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE kudu_student SET TBLPROPERTIES(&#39;kudu.table_name&#39; &#x3D; &#39;new_student&#39;);</span><br></pre></td></tr></table></figure>

<p>4.3将外部表重新映射kudu表</p>
<p>如果用户在使用过程中发现其他应用程序重新命名了kudu表，那么此时的外部表需要重新映射到kudu上。</p>
<p>首先创建一个外部表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE EXTERNAL TABLE external_table</span><br><span class="line">    STORED AS KUDU</span><br><span class="line">    TBLPROPERTIES (</span><br><span class="line">    &#39;kudu.master_addresses&#39; &#x3D; &#39;node1:7051,node2:7051,node3:7051&#39;,</span><br><span class="line">    &#39;kudu.table_name&#39; &#x3D; &#39;person&#39;</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重新映射外部表，指向不同的kudu表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE external_table</span><br><span class="line">SET TBLPROPERTIES(&#39;kudu.table_name&#39; &#x3D; &#39;hashTable&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面的操作是：将external_table映射的PERSON表重新指向hashTable表。</p>
<p>4.4 更改kudu master地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE my_table</span><br><span class="line">SET TBLPROPERTIES(&#39;kudu.master_addresses&#39; &#x3D; &#39;kudu-new-master.example.com:7051&#39;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.5 将内部表改为外部表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE my_table SET TBLPROPERTIES(&#39;EXTERNAL&#39; &#x3D; &#39;TRUE&#39;);</span><br></pre></td></tr></table></figure>

<p>##4 impala使用Java操作kudu</p>
<p>对于impala而言，开发人员是可以通过JDBC连接impala的，有了JDBC，开发人员可以通过impala来间接操作 kudu。</p>
<h3 id="1-引入依赖"><a href="#1-引入依赖" class="headerlink" title="1 引入依赖"></a>1 引入依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">   &lt;!--impala的jdbc操作--&gt; </span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.cloudera&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;ImpalaJDBC41&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.5.42&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--Caused by : ClassNotFound : thrift.protocol.TPro--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.thrift&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;libfb303&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.9.3&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--Caused by : ClassNotFound : thrift.protocol.TPro--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.thrift&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;libthrift&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.9.3&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line">   </span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.hive&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;hive-jdbc&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;exclusions&gt;</span><br><span class="line">            &lt;exclusion&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.hive&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;hive-service-rpc&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;&#x2F;exclusion&gt;</span><br><span class="line">            &lt;exclusion&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.hive&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;hive-service&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;&#x2F;exclusion&gt;</span><br><span class="line">        &lt;&#x2F;exclusions&gt;</span><br><span class="line">        &lt;version&gt;1.1.0&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--导入hive--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.hive&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;hive-service&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.1.0&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-jdbc连接impala操作kudu"><a href="#2-jdbc连接impala操作kudu" class="headerlink" title="2 jdbc连接impala操作kudu"></a>2 jdbc连接impala操作kudu</h3><p>使用JDBC连接impala操作kudu，与JDBC连接mysql做更重增删改查基本一样。</p>
<p>创建实体类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">package cn.itcast.impala.impala;</span><br><span class="line"></span><br><span class="line">public class Person &#123;</span><br><span class="line">    private int companyId;</span><br><span class="line">    private int workId;</span><br><span class="line">    private  String name;</span><br><span class="line">    private  String gender;</span><br><span class="line">    private  String photo;</span><br><span class="line"></span><br><span class="line">    public Person(int companyId, int workId, String name, String gender, String photo) &#123;</span><br><span class="line">        this.companyId &#x3D; companyId;</span><br><span class="line">        this.workId &#x3D; workId;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">        this.gender &#x3D; gender;</span><br><span class="line">        this.photo &#x3D; photo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getCompanyId() &#123;</span><br><span class="line">        return companyId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCompanyId(int companyId) &#123;</span><br><span class="line">        this.companyId &#x3D; companyId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getWorkId() &#123;</span><br><span class="line">        return workId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setWorkId(int workId) &#123;</span><br><span class="line">        this.workId &#x3D; workId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getGender() &#123;</span><br><span class="line">        return gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setGender(String gender) &#123;</span><br><span class="line">        this.gender &#x3D; gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPhoto() &#123;</span><br><span class="line">        return photo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPhoto(String photo) &#123;</span><br><span class="line">        this.photo &#x3D; photo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="JDBC连接impala对kudu进行增删改查"><a href="#JDBC连接impala对kudu进行增删改查" class="headerlink" title="JDBC连接impala对kudu进行增删改查"></a>JDBC连接impala对kudu进行增删改查</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.impala.impala;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Contants</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String JDBC_DRIVER=<span class="string">&quot;com.cloudera.impala.jdbc41.Driver&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span>  String CONNECTION_URL=<span class="string">&quot;jdbc:impala://node1:21050/default;auth=noSasl&quot;</span>;</span><br><span class="line">     <span class="comment">//定义数据库连接</span></span><br><span class="line">    <span class="keyword">static</span> Connection conn=<span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//定义PreparedStatement对象</span></span><br><span class="line">    <span class="keyword">static</span> PreparedStatement ps=<span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//定义查询的结果集</span></span><br><span class="line">    <span class="keyword">static</span> ResultSet rs= <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据库连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConn</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(JDBC_DRIVER);</span><br><span class="line">            conn=DriverManager.getConnection(CONNECTION_URL);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  conn;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个表</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createTable</span><span class="params">()</span></span>&#123;</span><br><span class="line">        conn=getConn();</span><br><span class="line">        String sql=<span class="string">&quot;CREATE TABLE impala_kudu_test&quot;</span> +</span><br><span class="line">                <span class="string">&quot;(&quot;</span> +</span><br><span class="line">                <span class="string">&quot;companyId BIGINT,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;workId BIGINT,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name STRING,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;gender STRING,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;photo STRING,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;PRIMARY KEY(companyId)&quot;</span> +</span><br><span class="line">                <span class="string">&quot;)&quot;</span> +</span><br><span class="line">                <span class="string">&quot;PARTITION BY HASH PARTITIONS 16 &quot;</span> +</span><br><span class="line">                <span class="string">&quot;STORED AS KUDU &quot;</span> +</span><br><span class="line">                <span class="string">&quot;TBLPROPERTIES (&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;kudu.master_addresses&#x27; = &#x27;node1:7051,node2:7051,node3:7051&#x27;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;kudu.table_name&#x27; = &#x27;impala_kudu_test&#x27;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;);&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ps = conn.prepareStatement(sql);</span><br><span class="line">            ps.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultSet <span class="title">queryRows</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//定义执行的sql语句</span></span><br><span class="line">            String sql=<span class="string">&quot;select * from impala_kudu_test&quot;</span>;</span><br><span class="line">            ps = getConn().prepareStatement(sql);</span><br><span class="line">            rs= ps.executeQuery();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>  rs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打印结果</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printRows</span><span class="params">(ResultSet rs)</span></span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         private int companyId;</span></span><br><span class="line"><span class="comment">         private int workId;</span></span><br><span class="line"><span class="comment">         private  String name;</span></span><br><span class="line"><span class="comment">         private  String gender;</span></span><br><span class="line"><span class="comment">         private  String photo;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (rs.next())&#123;</span><br><span class="line">                <span class="comment">//获取表的每一行字段信息</span></span><br><span class="line">                <span class="keyword">int</span> companyId = rs.getInt(<span class="string">&quot;companyId&quot;</span>);</span><br><span class="line">                <span class="keyword">int</span> workId = rs.getInt(<span class="string">&quot;workId&quot;</span>);</span><br><span class="line">                String name = rs.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                String gender = rs.getString(<span class="string">&quot;gender&quot;</span>);</span><br><span class="line">                String photo = rs.getString(<span class="string">&quot;photo&quot;</span>);</span><br><span class="line">                System.out.print(<span class="string">&quot;companyId:&quot;</span>+companyId+<span class="string">&quot; &quot;</span>);</span><br><span class="line">                System.out.print(<span class="string">&quot;workId:&quot;</span>+workId+<span class="string">&quot; &quot;</span>);</span><br><span class="line">                System.out.print(<span class="string">&quot;name:&quot;</span>+name+<span class="string">&quot; &quot;</span>);</span><br><span class="line">                System.out.print(<span class="string">&quot;gender:&quot;</span>+gender+<span class="string">&quot; &quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;photo:&quot;</span>+photo);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(ps!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ps.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(conn !=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    conn.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">insertRows</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">        conn=getConn();</span><br><span class="line">        String sql=<span class="string">&quot;insert into table impala_kudu_test(companyId,workId,name,gender,photo) values(?,?,?,?,?)&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ps=conn.prepareStatement(sql);</span><br><span class="line">            <span class="comment">//给占位符？赋值</span></span><br><span class="line">            ps.setInt(<span class="number">1</span>,person.getCompanyId());</span><br><span class="line">            ps.setInt(<span class="number">2</span>,person.getWorkId());</span><br><span class="line">            ps.setString(<span class="number">3</span>,person.getName());</span><br><span class="line">            ps.setString(<span class="number">4</span>,person.getGender());</span><br><span class="line">            ps.setString(<span class="number">5</span>,person.getPhoto());</span><br><span class="line">            ps.execute();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(ps !=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//关闭</span></span><br><span class="line">                    ps.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(conn !=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                      <span class="comment">//关闭</span></span><br><span class="line">                    conn.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateRows</span><span class="params">(Person person)</span></span>&#123;</span><br><span class="line">       <span class="comment">//定义执行的sql语句</span></span><br><span class="line">        String sql=<span class="string">&quot;update impala_kudu_test set workId=&quot;</span>+person.getWorkId()+</span><br><span class="line">                <span class="string">&quot;,name=&#x27;&quot;</span>+person.getName()+<span class="string">&quot;&#x27; ,&quot;</span>+<span class="string">&quot;gender=&#x27;&quot;</span>+person.getGender()+<span class="string">&quot;&#x27; ,&quot;</span>+</span><br><span class="line">                <span class="string">&quot;photo=&#x27;&quot;</span>+person.getPhoto()+<span class="string">&quot;&#x27; where companyId=&quot;</span>+person.getCompanyId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ps= getConn().prepareStatement(sql);</span><br><span class="line">            ps.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(ps !=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                      <span class="comment">//关闭</span></span><br><span class="line">                    ps.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(conn !=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                      <span class="comment">//关闭</span></span><br><span class="line">                    conn.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>   <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteRows</span><span class="params">(<span class="keyword">int</span> companyId)</span></span>&#123;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">//定义sql语句</span></span><br><span class="line">        String sql=<span class="string">&quot;delete from impala_kudu_test where companyId=&quot;</span>+companyId;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ps =getConn().prepareStatement(sql);</span><br><span class="line">            ps.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">//删除表</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dropTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql=<span class="string">&quot;drop table if exists impala_kudu_test&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ps =getConn().prepareStatement(sql);</span><br><span class="line">            ps.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="代码测试运行"><a href="#代码测试运行" class="headerlink" title="代码测试运行"></a>代码测试运行</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.impala.impala;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImpalaJdbcClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Connection conn = Contants.getConn();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建一个表</span></span><br><span class="line">       Contants.createTable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//插入数据</span></span><br><span class="line">       Contants.insertRows(<span class="keyword">new</span> Person(<span class="number">1</span>,<span class="number">100</span>,<span class="string">&quot;lisi&quot;</span>,<span class="string">&quot;male&quot;</span>,<span class="string">&quot;lisi-photo&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询表的数据</span></span><br><span class="line">        ResultSet rs = Contants.queryRows();</span><br><span class="line">        Contants.printRows(rs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新数据</span></span><br><span class="line">        Contants.updateRows(<span class="keyword">new</span> Person(<span class="number">1</span>,<span class="number">200</span>,<span class="string">&quot;zhangsan&quot;</span>,<span class="string">&quot;male&quot;</span>,<span class="string">&quot;zhangsan-photo&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除数据</span></span><br><span class="line">        Contants.deleteRows(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除表</span></span><br><span class="line">        Contants.dropTable();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="六-Apache-KUDU的原理"><a href="#六-Apache-KUDU的原理" class="headerlink" title="六 Apache KUDU的原理"></a>六 Apache KUDU的原理</h1><h2 id="1．-table与schema"><a href="#1．-table与schema" class="headerlink" title="1． table与schema"></a>1． table与schema</h2><p>Kudu设计是面向结构化存储的，因此，Kudu的表需要用户在建表时定义它的Schema信息，这些Schema信息包含：列定义（含类型），Primary Key定义（用户指定的若干个列的有序组合）。数据的唯一性，依赖于用户所提供的Primary Key中的Column组合的值的唯一性。Kudu提供了Alter命令来增删列，但位于Primary Key中的列是不允许删除的。 </p>
<p>从用户角度来看，Kudu是一种存储结构化数据表的存储系统。在一个Kudu集群中可以定义任意数量的table，每个table都需要预先定义好schema。每个table的列数是确定的，每一列都需要有名字和类型，每个表中可以把其中一列或多列定义为主键。这么看来，Kudu更像关系型数据库，而不是像HBase、Cassandra和MongoDB这些NoSQL数据库。不过Kudu目前还不能像关系型数据一样支持二级索引。</p>
<p>Kudu使用确定的列类型，而不是类似于NoSQL的“everything is byte”。带来好处：确定的列类型使Kudu可以进行类型特有的编码,可以提供元数据给其他上层查询工具。</p>
<h2 id="2-kudu底层数据模型"><a href="#2-kudu底层数据模型" class="headerlink" title="2 kudu底层数据模型"></a>2 kudu底层数据模型</h2><p>Kudu的底层数据文件的存储，未采用HDFS这样的较高抽象层次的分布式文件系统，而是自行开发了一套可基于Table/Tablet/Replica视图级别的底层存储系统。</p>
<p>这套实现基于如下的几个设计目标：</p>
<p>• 可提供快速的列式查询 </p>
<p>• 可支持快速的随机更新 </p>
<p>• 可提供更为稳定的查询性能保障</p>
<p><img src="/images/kudu/dcs.png" alt="img"></p>
<p>一张table会分成若干个tablet，每个tablet包括MetaData元信息及若干个RowSet。</p>
<p>RowSet包含一个MemRowSet及若干个DiskRowSet，DiskRowSet中包含一个BloomFile、Ad_hoc Index、BaseData、DeltaMem及若干个RedoFile和UndoFile。</p>
<p>MemRowSet：用于新数据insert及已在MemRowSet中的数据的更新，一个MemRowSet写满后会将数据刷到磁盘形成若干个DiskRowSet。默认是1G或者或者120S。</p>
<p>DiskRowSet：用于老数据的变更，后台定期对DiskRowSet做compaction，以删除没用的数据及合并历史数据，减少查询过程中的IO开销。</p>
<p>BloomFile：根据一个DiskRowSet中的key生成一个bloom filter，用于快速模糊定位某个key是否在DiskRowSet中。</p>
<p>Ad_hocIndex：是主键的索引，用于定位key在DiskRowSet中的具体哪个偏移位置。</p>
<p>BaseData是MemRowSet flush下来的数据，按列存储，按主键有序。</p>
<p>UndoFile是基于BaseData之前时间的历史数据，通过在BaseData上apply UndoFile中的记录，可以获得历史数据。</p>
<p>RedoFile是基于BaseData之后时间的变更记录，通过在BaseData上apply RedoFile中的记录，可获得较新的数据。</p>
<p>DeltaMem用于DiskRowSet中数据的变更，先写到内存中，写满后flush到磁盘形成RedoFile。</p>
<p>REDO与UNDO与关系型数据库中的REDO与UNDO日志类似（在关系型数据库中，REDO日志记录了更新后的数据，可以用来恢复尚未写入Data File的已成功事务更新的数据。而UNDO日志用来记录事务更新之前的数据，可以用来在事务失败时进行回滚）</p>
<p><img src="/images/kudu/dcs2.png" alt="img"></p>
<p>MemRowSets可以对比理解成HBase中的MemStore, 而DiskRowSets可理解成HBase中的HFile。</p>
<p>MemRowSets中的数据被Flush到磁盘之后，形成DiskRowSets。 DisRowSets中的数据，按照32MB大小为单位，按序划分为一个个的DiskRowSet。 DiskRowSet中的数据按照Column进行组织，与Parquet类似。</p>
<p>这是Kudu可支持一些分析性查询的基础。每一个Column的数据被存储在一个相邻的数据区域，而这个数据区域进一步被细分成一个个的小的Page单元，与HBase File中的Block类似，对每一个Column Page可采用一些Encoding算法，以及一些通用的Compression算法。 既然可对Column Page可采用Encoding以及Compression算法，那么，对单条记录的更改就会比较困难了。</p>
<p>前面提到了Kudu可支持单条记录级别的更新/删除，是如何做到的？</p>
<p>与HBase类似，也是通过增加一条新的记录来描述这次更新/删除操作的。DiskRowSet是不可修改了，那么 KUDU 要如何应对数据的更新呢？在KUDU中，把DiskRowSet分为了两部分：base data、delta stores。base data 负责存储基础数据，delta stores负责存储 base data 中的变更数据.</p>
<p><img src="/images/kudu/dcs3.png" alt="img"></p>
<p>如上图所示，数据从MemRowSet 刷到磁盘后就形成了一份 DiskRowSet（只包含 base data），每份 DiskRowSet 在内存中都会有一个对应的 DeltaMemStore，负责记录此 DiskRowSet 后续的数据变更（更新、删除）。DeltaMemStore 内部维护一个 B-树索引，映射到每个 row_offset 对应的数据变更。DeltaMemStore 数据增长到一定程度后转化成二进制文件存储到磁盘，形成一个 DeltaFile，随着 base data 对应数据的不断变更，DeltaFile 逐渐增长。</p>
<h2 id="3-tablet发现过程"><a href="#3-tablet发现过程" class="headerlink" title="3 tablet发现过程"></a>3 tablet发现过程</h2><p>当创建Kudu客户端时，其会从主服务器上获取tablet位置信息，然后直接与服务于该tablet的服务器进行交谈。</p>
<p>为了优化读取和写入路径，客户端将保留该信息的本地缓存，以防止他们在每个请求时需要查询主机的tablet位置信息。随着时间的推移，客户端的缓存可能会变得过时，并且当写入被发送到不再是tablet领导者的tablet服务器时，则将被拒绝。然后客户端将通过查询主服务器发现新领导者的位置来更新其缓存。</p>
<p><img src="/images/kudu/f.png" alt="img"></p>
<h2 id="4-kudu写流程"><a href="#4-kudu写流程" class="headerlink" title="4 kudu写流程"></a>4 kudu写流程</h2><p>当 Client 请求写数据时，先根据主键从Master Server中获取要访问的目标 Tablets，然后到依次对应的Tablet获取数据。</p>
<p>因为KUDU表存在主键约束，所以需要进行主键是否已经存在的判断，这里就涉及到之前说的索引结构对读写的优化了。一个Tablet中存在很多个RowSets，为了提升性能，我们要尽可能地减少要扫描的RowSets数量。</p>
<p>首先，我们先通过每个 RowSet 中记录的主键的（最大最小）范围，过滤掉一批不存在目标主键的RowSets，然后在根据RowSet中的布隆过滤器，过滤掉确定不存在目标主键的 RowSets，最后再通过RowSets中的 B-树索引，精确定位目标主键是否存在。</p>
<p>如果主键已经存在，则报错（主键重复），否则就进行写数据（写 MemRowSet）。</p>
<p><img src="/images/kudu/w.png" alt="img"></p>
<h2 id="5kudu读流程"><a href="#5kudu读流程" class="headerlink" title="5kudu读流程"></a>5kudu读流程</h2><p>数据读取过程大致如下：先根据要扫描数据的主键范围，定位到目标的Tablets，然后读取Tablets 中的RowSets。</p>
<p>在读取每个RowSet时，先根据主键过滤要scan范围，然后加载范围内的base data，再找到对应的delta stores，应用所有变更，最后union上MemRowSet中的内容，返回数据给Client。</p>
<p><img src="/images/kudu/r.png" alt="img"></p>
<h2 id="6kudu更新流程"><a href="#6kudu更新流程" class="headerlink" title="6kudu更新流程"></a>6kudu更新流程</h2><p>数据更新的核心是定位到待更新数据的位置，这块与写入的时候类似，就不展开了，等定位到具体位置后，然后将变更写到对应的delta store 中。</p>
<p><img src="/images/kudu/updata.png" alt="img"></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>HF
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2017/07/14/kudu/" title="Kudu">http://example.com/2017/07/14/kudu/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kudu/" rel="tag"># Kudu</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/07/13/Hue/" rel="prev" title="Hue">
      <i class="fa fa-chevron-left"></i> Hue
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/07/15/ClouderaManager/" rel="next" title="ClouderaManager">
      ClouderaManager <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#KuDu"><span class="nav-number">1.</span> <span class="nav-text">KuDu</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">一概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.1.</span> <span class="nav-text">背景介绍</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E6%9E%B6%E6%9E%84"><span class="nav-number">1.2.</span> <span class="nav-text">二架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1%EF%BC%8E-Table"><span class="nav-number">1.3.</span> <span class="nav-text">1． Table</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%EF%BC%8E-Tablet"><span class="nav-number">1.4.</span> <span class="nav-text">2． Tablet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%EF%BC%8E-Tablet-Server"><span class="nav-number">1.5.</span> <span class="nav-text">3． Tablet Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%EF%BC%8E-Master-Server"><span class="nav-number">1.6.</span> <span class="nav-text">4． Master Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89-kudu%E5%AE%89%E8%A3%85"><span class="nav-number">1.7.</span> <span class="nav-text">三 kudu安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1%EF%BC%8E-%E4%BF%AE%E6%94%B9master-gflagfile"><span class="nav-number">1.7.1.</span> <span class="nav-text">1.1． 修改master.gflagfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%BF%AE%E6%94%B9tserver-gflagfile"><span class="nav-number">1.7.2.</span> <span class="nav-text">1.2 修改tserver.gflagfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3%E4%BF%AE%E6%94%B9-etc-default-kudu-master"><span class="nav-number">1.7.3.</span> <span class="nav-text">1.3修改 &#x2F;etc&#x2F;default&#x2F;kudu-master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4%E4%BF%AE%E6%94%B9-etc-default-kudu-tserver"><span class="nav-number">1.7.4.</span> <span class="nav-text">1.4修改 &#x2F;etc&#x2F;default&#x2F;kudu-tserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1%E7%BB%99%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%8E%88%E4%BA%88sudo%E5%87%BA%E9%94%99"><span class="nav-number">1.7.5.</span> <span class="nav-text">1.1给普通用户授予sudo出错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%90%AF%E5%8A%A8kudu%E7%9A%84%E6%97%B6%E5%80%99%E6%8A%A5%E9%94%99"><span class="nav-number">1.7.6.</span> <span class="nav-text">1.2 启动kudu的时候报错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E6%8A%A5%E9%94%99"><span class="nav-number">1.7.7.</span> <span class="nav-text">1.3 启动过程中报错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E6%8A%A5%E9%94%99"><span class="nav-number">1.7.8.</span> <span class="nav-text">1.4 启动过程中报错</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B-Java%E6%93%8D%E4%BD%9Ckudu"><span class="nav-number">1.8.</span> <span class="nav-text">四 Java操作kudu</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E6%B3%95"><span class="nav-number">1.8.1.</span> <span class="nav-text">2 初始化方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="nav-number">1.8.2.</span> <span class="nav-text">3 创建表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="nav-number">1.8.3.</span> <span class="nav-text">4 插入数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="nav-number">1.8.4.</span> <span class="nav-text">5 查询数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="nav-number">1.8.5.</span> <span class="nav-text">6 修改数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="nav-number">1.8.6.</span> <span class="nav-text">7删除数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E5%88%A0%E9%99%A4%E8%A1%A8"><span class="nav-number">1.8.7.</span> <span class="nav-text">8 删除表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-kudu%E7%9A%84%E5%88%86%E5%8C%BA%E6%96%B9%E5%BC%8F"><span class="nav-number">1.8.8.</span> <span class="nav-text">9 kudu的分区方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%8C%83%E5%9B%B4%E5%88%86%E5%8C%BARange-Partitioning"><span class="nav-number">1.8.8.1.</span> <span class="nav-text">1 范围分区Range Partitioning</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%93%88%E5%B8%8C%E5%88%86%E5%8C%BAHash-Partitioning-%E4%B8%BAkudu%E7%9A%84%E9%BB%98%E8%AE%A4%E5%88%86%E5%8C%BA"><span class="nav-number">1.8.8.2.</span> <span class="nav-text">2 哈希分区Hash Partitioning 为kudu的默认分区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%A4%9A%E7%BA%A7%E5%88%86%E5%8C%BAMultilevel-Partitioning"><span class="nav-number">1.8.8.3.</span> <span class="nav-text">3 多级分区Multilevel Partitioning</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94-kudu%E9%9B%86%E6%88%90impala"><span class="nav-number">1.9.</span> <span class="nav-text">五 kudu集成impala</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-impala%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9"><span class="nav-number">1.9.1.</span> <span class="nav-text">1 impala的配置修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%9B%E5%BB%BAkudu%E8%A1%A8"><span class="nav-number">1.9.2.</span> <span class="nav-text">2 创建kudu表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8impala%E5%AF%B9kudu%E8%BF%9B%E8%A1%8CDML"><span class="nav-number">1.9.3.</span> <span class="nav-text">3 使用impala对kudu进行DML</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-number">1.9.4.</span> <span class="nav-text">1 引入依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-jdbc%E8%BF%9E%E6%8E%A5impala%E6%93%8D%E4%BD%9Ckudu"><span class="nav-number">1.9.5.</span> <span class="nav-text">2 jdbc连接impala操作kudu</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#JDBC%E8%BF%9E%E6%8E%A5impala%E5%AF%B9kudu%E8%BF%9B%E8%A1%8C%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="nav-number">1.9.5.0.1.</span> <span class="nav-text">JDBC连接impala对kudu进行增删改查</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95%E8%BF%90%E8%A1%8C"><span class="nav-number">1.9.5.0.2.</span> <span class="nav-text">代码测试运行</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD-Apache-KUDU%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">六 Apache KUDU的原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%EF%BC%8E-table%E4%B8%8Eschema"><span class="nav-number">2.1.</span> <span class="nav-text">1． table与schema</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-kudu%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.2.</span> <span class="nav-text">2 kudu底层数据模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-tablet%E5%8F%91%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="nav-number">2.3.</span> <span class="nav-text">3 tablet发现过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-kudu%E5%86%99%E6%B5%81%E7%A8%8B"><span class="nav-number">2.4.</span> <span class="nav-text">4 kudu写流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5kudu%E8%AF%BB%E6%B5%81%E7%A8%8B"><span class="nav-number">2.5.</span> <span class="nav-text">5kudu读流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6kudu%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B"><span class="nav-number">2.6.</span> <span class="nav-text">6kudu更新流程</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="HF"
      src="/images/hexo.jpg">
  <p class="site-author-name" itemprop="name">HF</p>
  <div class="site-description" itemprop="description">第二名就是头号输家</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">93</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      推荐阅读
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://www.54tianzhisheng.cn/tags/Flink/" title="http:&#x2F;&#x2F;www.54tianzhisheng.cn&#x2F;tags&#x2F;Flink&#x2F;" rel="noopener" target="_blank">Flink</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://nginxconfig.io/" title="https:&#x2F;&#x2F;nginxconfig.io&#x2F;" rel="noopener" target="_blank">Nginxconfig</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://linux.51yip.com/" title="http:&#x2F;&#x2F;linux.51yip.com&#x2F;" rel="noopener" target="_blank">Linux命令手册</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://echarts.baidu.com/index.html" title="https:&#x2F;&#x2F;echarts.baidu.com&#x2F;index.html" rel="noopener" target="_blank">echarts可视化库</a>
        </li>
    </ul>
  </div>
<div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>
      </div>

    
          <script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
         <script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
           <div class="widget-wrap">
        <h3 class="widget-title">Tag Cloud</h3>
        <div id="myCanvasContainer" class="widget tagcloud">
            <canvas width="250" height="250" id="resCanvas" style="width=100%">
                <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ai/" rel="tag">Ai</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azkaban/" rel="tag">Azkaban</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blog/" rel="tag">Blog</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ClouderaManager/" rel="tag">ClouderaManager</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElSearch/" rel="tag">ElSearch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flink/" rel="tag">Flink</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flume/" rel="tag">Flume</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/" rel="tag">Hadoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hbase/" rel="tag">Hbase</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hdfs/" rel="tag">Hdfs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hue/" rel="tag">Hue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Impala/" rel="tag">Impala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jvm/" rel="tag">Jvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kettle/" rel="tag">Kettle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kudu/" rel="tag">Kudu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Livy/" rel="tag">Livy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/" rel="tag">MapReduce</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oozie/" rel="tag">Oozie</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scala/" rel="tag">Scala</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sqoop/" rel="tag">Sqoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yarn/" rel="tag">Yarn</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZK/" rel="tag">ZK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8C%96%E6%8E%98%E5%BB%BA%E6%A8%A1/" rel="tag">挖掘建模</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" rel="tag">数据分析</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%AF%E8%A7%86%E5%8C%96/" rel="tag">数据分析与可视化</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/" rel="tag">数据处理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" rel="tag">数据结构与算法</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%8E%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习与深度学习</a><span class="tag-list-count">2</span></li></ul>
            </canvas>
        </div>
    </div>
    

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright" style=" text-align:center;">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HF</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">20:10</span>
</div>

  <!-- 网站运行时间的设置 -->
<div class="run_time" style=" text-align:center;">
  <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
  <script>
    var now = new Date(); 
    function createtime() { 
        var grt= new Date("07/23/2017 10:00:00");//此处修改你的建站时间或者网站上线时间 
        now.setTime(now.getTime()+250); 
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
    } 
    setInterval("createtime()",250);
  </script>
</div>
        
<div class="busuanzi-count" style=" text-align:center;">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      我的第 <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 位朋友，
    </span>
  



  
    <span class="site-pv">
      历经 <span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次回眸才与你相遇
    </span>
  
</div>










      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class='fas fa-chevron-down'></i>    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class='fas fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button">
    <svg class="moon-menu-bg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
    </svg>
    <div class="moon-menu-content">
      <div class="moon-menu-icon"><i class='fas fa-ellipsis-v'></i></div>
      <div class="moon-menu-text"></div>
    </div>
  </div>
</div><script src="/js/injector.js"></script>
</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/clicklove.js"></script>
<!-- 雪花特效 -->
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/snow.js"></script>